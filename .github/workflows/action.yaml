name: Trivy CSPM scan
​
on:
  pull_request:
    branches:
    - "*"
env:
  DOCKER_IMAGE: "accuknox/bootstrap:nginx"
  DOCKERFILE_CONTEXT: "${{ github.workspace }}/nginx/"
  CSPM_URL: "cspm.demo.accuknox.com"
  CSPM_TOKEN: "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ0b2tlbl90eXBlIjoic2xpZGluZyIsImV4cCI6MTY5NDc5NjE5NiwianRpIjoiNjY0MTNiNzAzNzBhNDU3OGIzZDg0MWEwODdiNDFlNzUiLCJyZWZyZXNoX2V4cCI6MTY5NDgzOTM5NiwidXNlcl9pZCI6MzcsInN1YiI6IjM3IiwiaWF0IjoxNjk0NzUyOTk2LCJ0ZW5hbnQtaWQiOjEzLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsidmlld19tb2R1bGVzIiwiZGVsZXRlX2NvbW1lbnRzX2FuYWx5c2lzIiwiZGVsZXRlX2NoYW5uZWxfaW50ZWdyYXRpb25zIiwiY3JlYXRlX3NldHRpbmdzIiwiY3dwcF9kZWxldGVfcmVnaXN0cnkiLCJkZWxldGVfdGFyZ2V0cyIsImNyZWF0ZV9ub3RpZmljYXRpb25zIiwiY3dwcF9hZGRfdGFncyIsImlnbm9yZV9maW5kaW5ncyIsImdldF9hcHBfYmVoYXZpb3IiLCJ2aWV3X2ZpbmRpbmdzIiwiY3JlYXRlX2ZpbmRpbmdzX2NvbmZpZyIsImRlbGV0ZV9jb250cm9scyIsImFkZF90YWdfZmluZGluZ3MiLCJ2aWV3X2NvbW1lbnRzX2FuYWx5c2lzIiwidmlld19hc3NldHMiLCJjd3BwX2RlbGV0ZV90YWdzIiwiY3dwcF9nZXRfcmVnaXN0cnlfc2NhbnMiLCJjcmVhdGVfcmVwb3J0cyIsInZpZXdfdGFncyIsImRlbGV0ZV9ncm91cHMiLCJkZWxldGVfcGxheWJvb2tzIiwiZmluZGluZ3NfYWRkX3RvX3RhcmdldCIsInJ1bl9zY2FucyIsImN3cHBfZ2V0X3RhZ3MiLCJkZWxldGVfcG9saWN5Iiwidmlld19taW5pb25zIiwiZGVsZXRlX2ZpbmRpbmdzX2NvbmZpZyIsImFkZF9wb2xpY3kiLCJ2aWV3X25vdGlmaWNhdGlvbnMiLCJkZWxldGVfc2NhbnMiLCJzYXZlX2RhdGFwaXBlbGluZV9maWx0ZXJzIiwiZXhwb3J0X2RhdGFsaXN0IiwiZ2V0X2NoYW5uZWxfaW50ZWdyYXRpb25zIiwiY3JlYXRlX3RhcmdldHMiLCJkZWxldGVfbW9uaXRvcnMiLCJleHBvcnRfZmluZGluZ3MiLCJjcmVhdGVfbWluaW9ucyIsImVkaXRfcG9saWN5IiwiZGVsZXRlX2Nsb3VkX2FjY291bnRzIiwidmlld19zZXR0aW5ncyIsInZpZXdfcGxheWJvb2tzIiwiY3dwcF9lZGl0X3JlZ2lzdHJ5IiwiZGVsZXRlX3VzZXJzIiwiZGFzaGJvYXJkIiwidGFnX3NjYW5zIiwiY3dwcF9kZWxldGVfbGFiZWxfZW50aXRpZXMiLCJ2aWV3X2NoZWNrcyIsImNoYW5nZV9wb2xpY3lfc3RhdHVzIiwiY3dwcF9nZXRfbGFiZWxfZW50aXRpZXMiLCJzYXZlX2NoYW5uZWxfaW50ZWdyYXRpb25zIiwiZGVsZXRlX3RyaWdnZXJzX2ZpbHRlcnMiLCJkZWxldGVfdGFncyIsInZpZXdfY2xvdWRfYWNjb3VudHMiLCJjcmVhdGVfZGF0YXBpcGVsaW5lX3RyaWdnZXJzIiwiZGF0YWxpc3RfYWRkX3RvX3RhcmdldCIsInZpZXdfZnVuY3Rpb25zIiwiZGVsZXRlX2Jhc2VsaW5lcyIsImRlbGV0ZV9yZXBvcnRzIiwidmlld191c2VycyIsInZpZXdfbGFiZWxzIiwiY3dwcF9nZXRfbGFiZWxzIiwidXBkYXRlX2RhdGFwaXBlbGluZV90cmlnZ2VycyIsInZpZXdfbW9uaXRvcnMiLCJjcmVhdGVfY2xvdWRfYWNjb3VudHMiLCJjd3BwX2RlbGV0ZV9sYWJlbHMiLCJnZXRfZGF0YXBpcGVsaW5lX3RyaWdnZXJzIiwiYXBwcm92ZV9wb2xpY3kiLCJjd3BwX2VkaXRfbGFiZWxzIiwiZ2V0X2FsbF9jbHVzdGVycyIsInZpZXdfdGFyZ2V0cyIsImlnbm9yZV9wb2xpY3kiLCJkZWxldGVfY29uZGl0aW9uIiwidXBkYXRlX2ZpbmRpbmdzIiwidmlld19jb250cm9scyIsInZpZXdfZ3JvdXBzIiwic2NyZWVuIiwiY3JlYXRlX3BsYXlib29rcyIsImdldF9kYXRhcGlwZWxpbmVfZmlsdGVycyIsImRhdGFsaXN0X2FkZF90b19ncm91cCIsImRlbGV0ZV9ub3RpZmljYXRpb25zIiwiZ2V0X3RyaWdnZXJzX2ZpbHRlcnMiLCJnZXRfZGF0YXBpcGVsaW5lX3RlbGVtZXRyeSIsInZpZXdfYmFzZWxpbmVzIiwiY3dwcF9hZGRfcmVnaXN0cnkiLCJjcmVhdGVfdGlja2V0cyIsInZpZXdfc2NhbnMiLCJ2aWV3X3JlcG9ydHMiLCJjcmVhdGVfdGFncyIsInRlc3RfY2hhbm5lbF9pbnRlZ3JhdGlvbnMiLCJjcmVhdGVfdXNlcnMiLCJnZXRfcG9saWN5IiwiZGVsZXRlX2xhYmVscyIsImNyZWF0ZV9ncm91cHMiLCJjcmVhdGVfY29udHJvbHMiLCJkZWxldGVfZmluZGluZ19jb21tZW50cyIsInZpZXdfZGF0YWxpc3QiLCJjcmVhdGVfZmluZGluZ19jb21tZW50cyIsImNyZWF0ZV9sYWJlbHMiLCJkZWxldGVfc2V0dGluZ3MiLCJkZWxldGVfZGF0YXBpcGVsaW5lX3RyaWdnZXJzIiwiYXNzZXRzX3VwZGF0ZV9iYXNlbGluZXMiLCJjd3BwX2dldF9yZWdpc3RyeSIsInZpZXdfY29uZGl0aW9uIiwidmlld190aWNrZXRzIiwiYXNzZXRzX2FkZF90YWciLCJ2aWV3X2ZpbmRpbmdfY29tbWVudHMiLCJ1cGRhdGVfZGF0YXBpcGVsaW5lX2ZpbHRlcnMiLCJjd3BwX2FkZF9sYWJlbF9lbnRpdGllcyIsImRlbGV0ZV9kYXRhcGlwZWxpbmVfZmlsdGVycyIsImRlbGV0ZV9kYXRhbGlzdF9jb25maWciLCJ2aWV3X2V4cGVjdGVkX3ZhcmlhYmxlIiwiY3JlYXRlX2NvbmRpdGlvbiIsImRlbGV0ZV90aWNrZXRzIiwiY3JlYXRlX21vbml0b3JzIiwiZmluZGluZ3NfYWRkX3RvX2dyb3VwIiwiY3JlYXRlX2NvbW1lbnRzX2FuYWx5c2lzIiwiY3dwcF9hZGRfbGFiZWxzIiwic2F2ZV90cmlnZ2Vyc19maWx0ZXJzIiwiY3JlYXRlX2Jhc2VsaW5lcyIsImRlbGV0ZV9taW5pb25zIiwiY3JlYXRlX2RhdGFsaXN0X2NvbmZpZyJdfSwiaXNzIjoiY3NwbS5hY2N1a25veC5jb20ifQ.aDrTlih1g0RiGXEBxCEhyjdf5jPiARMuFEC3FmgP1f3BMTG_8-N4Gr1_sTnj2TCiqHJ3PAhdmhoThtW_mB9U5w7znpQ4KNQ0ZUgRAyAlZVbiEnzEv9Xb5ZzPAH0q6artJjBV2aj9KOBSuoA6MQdEO6DnLgTJ1aVeADna9vbmPFK3QOLBs2WNzXVunZeYqLSpPiVHp-4FZNrr3jGIklEUnGXGrSB1n7kfMsBNYzC6spn3xb8-GY95crss_RzVq779jZLvm_GKcJcWPxqYPfU2BeNVBpM8zBNKV0hgEmxG8lR4C27P7xcJqqEkpmO3_JG_BYzmxQd05_7uN0gCN8stgA"
  #CSPM_TOKEN: "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNjk2NDExMzIwLCJqdGkiOiIzMjFiNjYxZTJmN2Q0MGNjOWVmMDU5OWQ5NWU4NDk1MiIsImlzcyI6ImNzcG0uZGVtby5hY2N1a25veC5jb20ifQ.L99J1OtKQy-Wm7ZrLlFYEwEw_6HSk20gq6bkZ9jayNX_vXHF7TKYc-ogNNUrvtpncdHB4l15WBzVdTInLENcQwXYTfFg7XXf83zBO7awBVswk8k7gGNJwhtu8qnfMgVqf_838qDOT6OkaPdkKSW5-uingKXhU1g1D0W8FX1JgjKGDrG2YyD45IUHVwCLr-KEZmLkWrEfNYn34EtQphlimxVJPm04ZTIE45JxYKF1xpiinUOYJTvot7NFiU7Asy9w6OFSjbFPVmWaT4Af19GUzgp70mkVJP6HrvwOqqH_KdzieHNcI525SfUM5ujayBzqz4IcAF5AomXZxUbrGOidzw"
  #"expiry_at": "2023-10-04T09:22:00Z",
  #"created_at": "2023-09-04T09:22:00.996979Z",
  TENANT_ID: "13"
​
jobs:
  build:
    name: Build
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Build an image from Dockerfile
        run: |
          docker build -t ${{env.DOCKER_IMAGE}} ${{env.DOCKERFILE_CONTEXT}}
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{env.DOCKER_IMAGE}}
          format: 'json'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          output: 'results.json'
      - name: Push report to CSPM panel
        run: |
          curl --location --request POST 'https://${{env.CSPM_URL}}/api/v1/artifact/?tenant_id=${{ env.TENANT_ID }}&data_type=TR&save_to_s3=false' --header 'Authorization: Bearer ${{ env.CSPM_TOKEN }}' --form 'file=@"./results.json"'
